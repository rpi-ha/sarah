rule "Motion sensor [motion-room-lbl] received ON"
when
    Item [motion-alarm] received update ON or
    Item [motion-alarm] received update OPEN
then
	//*** update these as needed ***//
	var GenericItem deviceLight        = [light-binary]
	val String motionLocation          = "[motion-location]"
	var boolean motionIsOutside        = [is-outside]

	//*** leave these as is ***//
	val String motionSpeak             = [motion-msg]
	val int lumiLevel                  = lvroomLumiLevel
	val int timeoutMins                = lvroomTimeoutMins
	val String lumiName                = triggeringItem.name.substring(0, triggeringItem.name.toLowerCase().indexOf('_alarm')) + '_Lumi'
	var GenericItem deviceMotionLumi   = Luminance.members.findFirst[ a | a.name == lumiName]
	//var String rtn                     = ""

	logInfo("Motion", "==> motion sensor activated - " + motionLocation)
	logInfo("Motion", "    state: " + triggeringItem.previousState.state.toString)
	logInfo("Motion", "prevstate: " + triggeringItem.previousState(true).state.toString)
	logInfo("Motion", " litstate: " + deviceLight.state.toString)
    logInfo("Motion", " lvroomMotionTriggered: " + lvroomMotionTriggered)

	if(deviceMotionLumi.state <= lumiLevel && deviceLight.state == OFF) {
		deviceLight.sendCommand(ON)

		if(! lvroomMotionTriggered) {
    		lvroomMotionTriggered = true
    		
			if(SilentSwitch.state != ON) {
				if(!motionIsOutside && AnnounceInsideMotionSwitch.state == ON) {
					//say(motionSpeak)
					rtn = sayText.apply(motionSpeak)
				} else if(motionIsOutside && AnnounceOutsideMotionSwitch.state == ON) {
					//say(motionSpeak)
					rtn = sayText.apply(motionSpeak)
				}
			}
		}
	} else if(deviceMotionLumi.state > lumiLevel) {
	    if(deviceLight.state == ON) {
			deviceLight.sendCommand(OFF)
			rtn = delaySomeSecs.apply( 5, "Motion")
			deviceLight.sendCommand(OFF)
		}

		[motion-room-nam]MotionTriggered = false
	}

	//*** update this timer with appropriate global timer ***//
	if([motion-room-nam]MotionTimer === null) {
		logInfo("Motion", "activate motion timer - " + motionLocation)

		//*** update these 3 entries with appropriate global timer ***//
		[motion-room-nam]MotionTimer = createTimer(now.plusMinutes(timeoutMins), [|
			logInfo("Motion", "cancel motion timer - " + motionLocation)

			deviceLight.sendCommand(OFF)
			rtn = delaySomeSecs.apply( 5, "Motion")
			deviceLight.sendCommand(OFF)
		
			[motion-room-nam]MotionTimer.cancel()
			[motion-room-nam]MotionTimer = null
			[motion-room-nam]MotionTriggered = false
		])
	} else {
		//*** update this timer with appropriate global timer ***//
		[motion-room-nam]MotionTimer.reschedule(now.plusMinutes(timeoutMins))
		logInfo("Motion", "add time to motion timer - " + motionLocation)
	}
end
